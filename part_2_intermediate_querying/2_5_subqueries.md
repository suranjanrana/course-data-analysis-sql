# Topic 9 — Subqueries (Query Inside a Query)

## 9.1 What is a Subquery?

A subquery is a SQL query nested inside another query.

- The inner query runs first
- The outer query uses the result of the inner query

Why analysts use subqueries:

- Filter using aggregated values (e.g., above average)
- Compare rows against group-level metrics
- Perform step-by-step logic without temp tables
- Replace complex joins in certain scenarios

## 9.2 Types of Subqueries

| Type                | Description              | Analyst Use             |
| ------------------- | ------------------------ | ----------------------- |
| Scalar Subquery     | Returns single value     | Comparisons, thresholds |
| Row Subquery        | Returns one row          | Advanced filters        |
| Column Subquery     | Returns one column       | IN / NOT IN             |
| Table Subquery      | Returns multiple rows    | Derived datasets        |
| Correlated Subquery | Depends on outer query   | Row-wise logic          |
| Nested Subqueries   | Subquery inside subquery | Complex analytics       |

## 9.3 General Syntax

```sql
SELECT column
FROM table
WHERE column OPERATOR (
    SELECT column
    FROM table
);
-- Inner query executes first
```

## 9.4 Scalar Subqueries

### Example: Orders Above Average Order Amount

```sql
SELECT orderid, amount
FROM sales.orders
WHERE amount > (
    SELECT AVG(amount)
    FROM sales.orders
);
-- Scalar subquery calculates overall average sales value
```

## 9.5 Subqueries with IN / NOT IN

### Employees Who Have Made Sales

```sql
SELECT firstname
FROM hr.employees
WHERE empid IN (
    SELECT empid
    FROM sales.orders
);
-- Identifies active sales employees
```

## 9.6 Subqueries in SELECT Clause

### Total Sales Made by Each Employee

```sql
SELECT e.firstname,
       (
           SELECT SUM(o.amount)
           FROM sales.orders o
           WHERE o.empid = e.empid
       ) AS total_sales
FROM hr.employees e;
-- Correlated subquery
-- Calculates total revenue generated by each employee
-- Returns NULL if employee has no sales
```

## 9.7 Correlated Subqueries

### Orders Above Employee’s Average Sale

```sql
SELECT orderid, empid, amount
FROM sales.orders o
WHERE amount > (
    SELECT AVG(amount)
    FROM sales.orders
    WHERE empid = o.empid
);
-- Inner query recalculates average per employee
-- Very common performance analysis pattern
```

---

### Highest Sale Per Employee

```sql
SELECT orderid, empid, amount
FROM sales.orders o
WHERE amount = (
    SELECT MAX(amount)
    FROM sales.orders
    WHERE empid = o.empid
);
-- Finds best-performing deal per sales rep
```

## 9.8 Nested Subqueries (Advanced Analytics)

### High Performing Employees

```sql
SELECT empid, total_sales
FROM (
    SELECT empid, SUM(amount) AS total_sales
    FROM sales.orders
    GROUP BY empid
) t
WHERE total_sales > (
    SELECT AVG(total_sales)
    FROM (
        SELECT SUM(amount) AS total_sales
        FROM sales.orders
        GROUP BY empid
    ) x
);
-- Multi-layer aggregation
-- Identifies above-average performers
```

## 9.9 EXISTS

### Employees Who Have Made at Least One Sale (EXISTS)

```sql
SELECT firstname
FROM hr.employees e
WHERE EXISTS (
    SELECT 1
    FROM sales.orders o
    WHERE o.empid = e.empid
);
-- EXISTS checks if at least one related row exists
-- Safer and faster than IN for large datasets
```

---

### Employees With No Sales (NOT EXISTS)

```sql
SELECT firstname
FROM hr.employees e
WHERE NOT EXISTS (
    SELECT 1
    FROM sales.orders o
    WHERE o.empid = e.empid
);
-- Identifies inactive or underperforming sales reps
```

## 9.10 Note

- Subqueries execute inside -> outside
- Scalar subqueries must return exactly one value
- Use **EXISTS** for perfromance & NULL safety
- Correlated subquerrries can be slower than joins
- Nested subqueries are powerful but harder to read
- Use CTEs later for clarity

## 9.11 Other Examples

### Scenario 1: High-Performing Employees (Above Average Sales)

```sql
SELECT empid
FROM sales.orders
GROUP BY empid
HAVING SUM(amount) > (
    SELECT AVG(total_sales)
    FROM (
        SELECT SUM(amount) AS total_sales
        FROM sales.orders
        GROUP BY empid
    ) t
);
-- Identifies sales reps performing above average
-- Nested aggregation logic
```

---

### Scenario 2: Employees With Sales Only in 2023

```sql
SELECT DISTINCT empid
FROM sales.orders
WHERE empid NOT IN (
    SELECT empid
    FROM sales.orders
    WHERE order_date < '2023-01-01'
);
-- Employees whose sales history starts in 2023
```

---

### Scenario 3: Top Sale Per Employee

```sql
SELECT orderid, empid, amount
FROM sales.orders o
WHERE amount = (
    SELECT MAX(amount)
    FROM sales.orders
    WHERE empid = o.empid
);
-- Classic interview and real-world query
-- Window function version will come later
```

## Note

When reviewing subquery examples, always ask:

1. Who owns the foreign key?
    - sales.orders.empid
2. What business question am I answering?
    - Employee performance, not purchases
3. Does the relationship make sense without assumptions?
    - Yes: sales credited to employee
